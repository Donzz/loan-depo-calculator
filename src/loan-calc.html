<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!--Created by Kirill Danilov-->

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/datepicker.css" rel="stylesheet">
    <link href="css/prettify.css" rel="stylesheet">
<body>

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="js/jquery-3.1.1.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="js/bootstrap.min.js"></script>
<script src="js/bootstrap-datepicker.js"></script>
<script src="js/bootstrap-datepicker.ru.js"></script>
<script src="js/prettify.js"></script>

<script language="JavaScript">
    function computeMonthAnnuity( amount, rate, months, isRounded )
    {
        var monthRate = rate / 12;
        var annuity = amount * ( monthRate / ( 1 - Math.pow( 1 + monthRate, -months ) ) );
        if( isRounded )
        {
            annuity = Math.round( annuity );
        }
        else
        {
            annuity = Math.round( annuity * 100 ) / 100;
        }
        return annuity;
    }

    function createInstalment( amount, annuity, rate, loanStartDate, firstPaymentDate, periodsPercentOnly )
    {
        var instalment = [];
        var millisInDay = 1000 * 60 * 60 * 24;
        var curAmount = amount;
        var curPercent;
        var curLoan;
        var curPaymentDate = loanStartDate;
        //noinspection UnnecessaryLocalVariableJS
        var curNewPaymentDate = firstPaymentDate;
        var curPeriod;
        var curRow;
        for( var i = 0; curAmount > 0; i++ )
        {
            curPeriod = ( curNewPaymentDate.getTime() - curPaymentDate.getTime() ) / millisInDay;
            curPercent = Math.round( curAmount * curPeriod * rate / 365 * 100 ) / 100;

            if( i >= periodsPercentOnly )
            {
                curLoan = Math.round( ( annuity - curPercent ) * 100 ) / 100;
            }
            else
            {
                curLoan = 0;
            }
            if( curAmount - curLoan < 0 )
            {
                curLoan = curAmount;
            }
            curAmount = Math.round( ( curAmount - curLoan ) * 100 ) / 100;


            curRow =
            {
                row: i + 1,
                date: new Date( curNewPaymentDate.getTime() ),
                annuity: getFormattedSum( curPercent + curLoan ),
                percent: getFormattedSum( curPercent ),
                loan: getFormattedSum( curLoan ),
                remainLoan: getFormattedSum( curAmount )
            };
            instalment.push( curRow );

            curPaymentDate = new Date( curNewPaymentDate.getTime() );
            curNewPaymentDate.setMonth( curNewPaymentDate.getMonth() + 1 );
        }

        if( curAmount > 0 )
        {
            curPeriod = ( curNewPaymentDate.getTime() - curPaymentDate.getTime() ) / millisInDay;
            curPercent = Math.round( curAmount * curPeriod * rate / 365 * 100 ) / 100;
            curLoan = curAmount;
            curAmount = curAmount - curLoan;

            curRow =
            {
                row: i + 1,
                date: new Date( curNewPaymentDate.getTime() ),
                annuity: getFormattedSum( curPercent + curLoan ),
                percent: getFormattedSum( curPercent ),
                loan: getFormattedSum( curLoan ),
                remainLoan: getFormattedSum( curAmount )
            };
            instalment.push( curRow );
        }

        return instalment;
    }

    function computeAndShow()
    {
        var amount = document.getElementById( "amount" ).value.replace( / /g, '' );
        var rate = document.getElementById( "rate" ).value;
        if( rate.indexOf( "," ) != -1 )
        {
            rate = rate.replace( ",", "." );
        }
        var months = document.getElementById( "months" ).value;
        var normalRate = rate > 1 ? rate / 100 : rate;

        var loanStartDate = getNormalDateStr( document.getElementById( "loanStartDate" ).value );
        var firstPaymentDate = getNormalDateStr( document.getElementById( "firstPaymentDate" ).value );

        var isRounded = document.getElementById( "isRoundedAnnuity" ).checked;
        var periodsPercentOnly = document.getElementById( "periodsPercentOnly" ).value;
        var annuity = computeMonthAnnuity( amount, normalRate, months, isRounded );

        document.getElementById( "annuity" ).innerHTML = getFormattedSum( annuity );
        var instalment = createInstalment( amount, annuity, normalRate, loanStartDate, firstPaymentDate, periodsPercentOnly );

        var table = document.getElementById( "instalmentTable" );
        var tBodies = table.tBodies;
        for( var j = 0; j < tBodies.length; j++ )
        {
            table.removeChild( tBodies[0] );
        }
        var tbody = document.createElement( "tbody" );
        table.appendChild( tbody );
        var tr;
        var row;

        for( var i = 0; i < instalment.length; i++ )
        {
            tr = document.createElement( "tr" );

            row = instalment[i];
            tr.insertCell( 0 ).appendChild( document.createTextNode( row.row ) );
            tr.insertCell( 1 ).appendChild( document.createTextNode( getFormattedDate( row.date ) ) );
            tr.insertCell( 2 ).appendChild( document.createTextNode( row.annuity ) );
            tr.insertCell( 3 ).appendChild( document.createTextNode( row.percent ) );
            tr.insertCell( 4 ).appendChild( document.createTextNode( row.loan ) );
            tr.insertCell( 5 ).appendChild( document.createTextNode( row.remainLoan ) );
            tbody.appendChild( tr );
        }
    }

    function getNormalDateStr( dateStr )
    {
        var dateNormal = dateStr.split( '.' );
        //noinspection UnnecessaryLocalVariableJS
        var dateOut = new Date( dateNormal[2], dateNormal[1] - 1, dateNormal[0] );
        return dateOut;
    }

    function getFormattedDate( date )
    {
        var year = date.getFullYear();
        var month = (1 + date.getMonth()).toString();
        month = month.length > 1 ? month : '0' + month;
        var day = date.getDate().toString();
        day = day.length > 1 ? day : '0' + day;
        return day + '.' + month + '.' + year;
    }

    function getFormattedSum( sum )
    {
        var sumStr = sum.toString();
        if( sumStr.indexOf( '.' ) == -1 )
        {
            return sumStr + ".00";
        }
        var integer = sumStr.substring( 0, sumStr.indexOf( '.' ) );
        var fract = sumStr.substring( sumStr.indexOf( '.' ) + 1 );
        while( fract.length < 2 )
        {
            fract += '0';
        }
        fract = fract.substring( 0, 2 );
        return integer + '.' + fract;
    }

    function setPaymentStartDate()
    {
        var loanStartDate = getNormalDateStr( document.getElementById( "loanStartDate" ).value );
        loanStartDate.setMonth( loanStartDate.getMonth() + 1 );
        document.getElementById( "firstPaymentDate" ).value = getFormattedDate( loanStartDate );
        document.getElementById( "dp2" ).setAttribute( "data-date", getFormattedDate( loanStartDate ) );
        $( '#dp2' ).datepicker( 'update', getFormattedDate( loanStartDate ) );
    }

</script>

<div class="col-lg-1">
    <label for="amount">
        Сумма:
    </label>
    <br/>
    <br/>
    <input id="amount" type="text" value="3000000" class="form-control"/>
</div>
<div class="col-lg-1">
    <label for="rate">
        Годовая ставка, %:
    </label>
    <input id="rate" type="text" value="25" class="form-control"/>
</div>
<div class="col-lg-1">
    <label for="months">
        Количество месяцев:
    </label>
    <input id="months" type="number" value="60" class="form-control"/>
</div>
<div class="col-lg-1">
    <label for="loanStartDate">
        Дата выдачи кредита:
    </label>

    <div class="input-append date" id="dp1" data-date="30.01.2017" data-date-format="dd.mm.yyyy">
        <input id="loanStartDate" type="text" value="30.01.2017" class="form-control" onchange="setPaymentStartDate()"/>
        <span class="add-on"></span>
    </div>
    <script type="text/javascript">
        $( function ()
        {
            $( '#dp1' ).datepicker( {
                autoclose: true,
                language: "ru",
                weekStart: 1
            } );
        } );
    </script>
</div>

<div class="col-lg-1">
    <label for="firstPaymentDate">
        Дата начала платежей:
    </label>

    <div class="input-append date" id="dp2" data-date="02.03.2017" data-date-format="dd.mm.yyyy">
        <input id="firstPaymentDate" type="text" class="form-control" value="02.03.2017"/>
        <span class="add-on"></span>
    </div>
    <script type="text/javascript">
        $( function ()
        {
            $( '#dp2' ).datepicker( {
                autoclose: true,
                language: "ru",
                weekStart: 1
            } );
        } );
    </script>
</div>
<br/>
<br/>
<br/>
<br/>
<br/>
<br/>

<div class="col-lg-2">
    <label>
        <input id="periodsPercentOnly" type="number" min="0" max="1000" value="1"> сколько периодов с начислением только
        процентов
    </label>
</div>
<div class="col-lg-2">
    <label>
        <input id="isRoundedAnnuity" type="checkbox"> округленный аннуитет
    </label>
</div>
<br/>
<br/>
<br/>
<br/>

<div class="col-lg-4">
    <input id="submit" type="button" onclick="computeAndShow()" value="Рассчитать" class="btn btn-lg">
</div>
<br/>
<br/>
<br/>

<p>

<div class="col-lg-2">
    <table>
        <tr>
            <td><b>Аннуитетный платеж:&nbsp;</b></td>
            <td>
                <div id="annuity"></div>
            </td>
        </tr>
    </table>
</div>
<br/>
<br/>

<div class="col-md-9">
    <div class="table-responsive">
        <table id="instalmentTable" class="table table-striped">
            <thead>
            <tr>
                <th><b>#</b></th>
                <th><b>Дата</b></th>
                <th><b>Платеж</b></th>
                <th><b>Проценты</b></th>
                <th><b>Основной долг</b></th>
                <th><b>Остаток долга</b></th>
            </tr>
            </thead>
        </table>
    </div>
</div>
</body>
</html>